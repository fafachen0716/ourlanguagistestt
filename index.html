<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸŒ èªåœ° å°ç£èªè¨€èšæœƒåˆ†äº«ï½œLanguaGIS</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont@2.47.0/tabler-icons.min.css" />
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0c; --panel:#111214; --muted:#9aa0a6; --text:#e8eaed; --accent:#8ab4f8; --card:#15171a; --chip:#1d1f24; --ok:#34a853; --warn:#fbbc04; --err:#ea4335;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--accent);text-decoration:none}
    header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ— */
    gap: 0.5rem;
    padding: 0.3rem 0.5rem;
    z-index: 1000;
    background: linear-gradient(
      to bottom,
      rgba(0,0,0,0.4) 0px,
      rgba(0,0,0,0.4) 20px,
      rgba(255, 255, 255, 0) 60px
    );

  }

      header h1 {
      font-size: 1rem;   
      font-weight: 600;      
      color: #ffffff;
      letter-spacing: 0.2px; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;

    }


    header .toolbar {
      display: flex;
      flex-wrap: wrap;      /* å·¥å…·åˆ—å¯ä»¥æ›è¡Œ */
      gap: 0.4rem;
    }

    header .btn {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.675rem;
      flex-shrink: 0;       /* é¿å…è¢«å£“ç¸® */
      white-space: nowrap;   /* æ–‡å­—ä¸æ›è¡Œ */
    }


    .btn{display:inline-flex;align-items:center;gap:.4rem;border:1px solid #2a2c30;background:var(--chip);color:var(--text);padding:.4rem .7rem;border-radius:999px;cursor:pointer}
    .btn:hover{border-color:#3a3d43}

    #btnShowFav.active {
      background-color: #fdd;   /* èƒŒæ™¯é¡è‰²è®Šæ·¡ç´… */
      color: #c00;              /* æ–‡å­—è®Šç´… */
      border: 1px solid #c00;   /* é‚Šæ¡†ç´…è‰² */
    }

    #btnShowFav.active i {
      color: #c00;              /* icon é¡è‰²ä¹Ÿè®Šç´… */
    }

    .layout{display:grid;grid-template-columns: 360px 1fr; gap:0; height:100%;}
    @media (max-width: 1000px){.layout{grid-template-columns:1fr}}

    .layout.collapsed {
      grid-template-columns: 0 1fr;
    }


    .layout.collapsed #sidebar {
      transform: translateX(-100%);
    }


    #sidebar{
    position: fixed;      /* æµ®åœ¨åœ°åœ–ä¸Š */
    top: 6rem;          /* ç•™ header é«˜åº¦ */
    bottom: 3rem;
    left: 0;
    width: 360px;
    height: calc(100% - 3.2rem);
    background: var(--panel);
    border-right: 1px solid #202327;
    overflow-y: auto;
    transition: transform 0.3s ease;
    z-index: 1001;        /* header 1000ï¼Œsidebar åœ¨ header ä¸‹æ–¹æˆ–å¯èª¿æ•´ */

    }
    #map {
      position: absolute;
      inset: 0;       /* ç­‰åŒ top:0; right:0; bottom:0; left:0; */
      width: 100%;
      height: 100%;
      z-index: 0;     /* åœ°åœ–åœ¨åº•å±¤ */
    }


    .section{padding:1rem .9rem;border-bottom:1px solid #202327}
    .search{display:flex;gap:.6rem}
    .search input{flex:1;background:#0c0d10;border:1px solid #2b2f35;border-radius:12px;padding:.55rem .7rem;color:var(--text)}
    .chip{display:inline-flex;gap:.4rem;align-items:center;background:var(--chip);border:1px solid #2a2c30;border-radius:999px;padding:.25rem .5rem;font-size:.85rem;margin:.2rem .2rem 0 0}
    .toggle{display:inline-flex;align-items:center;gap:.35rem;cursor:pointer}
    .toggle input{accent-color:var(--accent)}

    .list{display:grid;gap:.6rem;padding:.8rem .9rem}
    .card{background:var(--card);border:1px solid #22252b;border-radius:16px;padding:.7rem}
    .card h3{margin:.2rem 0 .1rem;font-size:1rem}
    .card .desc-scroll {
      max-height: 100px;   /* å¯ä»¥èª¿æ•´é«˜åº¦ */
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .meta{font-size:.85rem;color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:.6rem}
    .fav{cursor:pointer;display:inline-flex;align-items:center;gap:.35rem;font-size:.9rem}
    .fav .ti{font-size:20px}

    /* Popup content */
    .popup {
      min-width: 200px;      /* æœ€å°å¯¬åº¦ */
      max-width: 90vw;       /* æ‰‹æ©Ÿè¢å¹•æœ€å¤§å¯¬åº¦ä¸è¦è¶…éè¦–çª— */
    }

    .popup .cover {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #2a2c30;
      cursor: pointer;
      object-fit: cover;     /* é¿å…åœ–ç‰‡è®Šå½¢ */
      max-height: 200px;     /* æ‰‹æ©Ÿé™åˆ¶é«˜åº¦ */
    }

  .popup .desc-scroll {
    max-height: 100px;   /* æ§åˆ¶é«˜åº¦ï¼Œå¯èª¿æ•´ */
    overflow-y: auto;
    white-space: pre-wrap;
  }

    .info {
      display: grid;
      gap: 0.35rem;
      margin-top: 0.5rem;
    }

    .info .line {
      display: flex;
      gap: 0.5rem;
      align-items: flex-start;
      flex-wrap: wrap;       /* æ–‡å­—å¤ªé•·æ›è¡Œ */
    }

    .badge {
      display: inline-flex;
      align-items: center;
      color: white;
      border: 1px solid #2a2c30;
      background: var(--chip);
      border-radius: 8px;
      padding: 0.1rem 0.4rem;
      font-size: 0.8rem;
      word-break: break-word; /* é¿å…æ–‡å­—æº¢å‡º */
    }

    /* æ‰‹æ©Ÿå°ˆç”¨ï¼šæ›´å° max-width */
    @media (max-width: 768px) {
      .popup {
        min-width: 180px;
        max-width: 90vw;
      }
      .popup .cover {
        max-height: 150px;
      }
    }


    .info{display:grid;gap:.35rem;margin-top:.5rem}
    .info .line{display:flex;gap:.5rem;align-items:flex-start}
    .badge{display:inline-flex;align-items:center;color: white;border:1px solid #2a2c30;background:var(--chip);border-radius:8px;padding:.1rem .4rem;font-size:.8rem}

    /* Modal for image */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal.open{display:flex}
    .modal img{max-width:92vw;max-height:92vh;border-radius:12px;border:1px solid #444}

/* Footer åŸºæœ¬æ¨£å¼ */
footer {
  position: fixed;
  bottom: 10px;
  left :10px;
  z-index: 1200;
  background: rgba(17,18,20,1);
  border: 1px solid #2a2c30;
  border-radius: 999px;
  padding: 0.6rem 0.9rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: nowrap;      /* ä¸æ›è¡Œ */
  overflow-x: auto;       /* é¿å…è¶…å‡ºå¯¬åº¦ */
}

/* Footer å…§é€£çµåœ–ç¤ºæ–‡å­—è‡ªé©æ‡‰ */
footer a, footer span {
  flex-shrink: 0;         /* ä¸ç¸®å° */
  white-space: nowrap;    /* æ–‡å­—ä¸æ›è¡Œ */
  font-size: 0.85rem;
}

/* æ‰‹æ©Ÿ RWD èª¿æ•´ */
@media (max-width: 480px) {
  footer {
    padding: 0.4rem 0.6rem;  /* ç¸®å°å…§é‚Šè· */
    gap: 0.3rem;             /* åœ–ç¤ºé–“è·ç¸®å° */
    font-size: 0.75rem;      /* æ–‡å­—ç¸®å° */
  }

  footer a i {
    font-size: 1rem;         /* åœ–ç¤ºç¸®å° */
  }
}

  </style>
</head>
<body>
  <header>
    <h1>
      ğŸŒ å°ç£èªè¨€äº¤æ›åœ°åœ–ï½œLanguaGIS
    </h1>
    <div class="toolbar">
      <button id="btnAdd" class="btn" title="æ–°å¢æ´»å‹•ï¼ˆGoogle è¡¨å–®ï¼‰">
        <i class="ti ti-square-rounded-plus"></i><span>æ–°å¢æ´»å‹•</span>
      </button>
      <!--
      <a id="btnSheet" class="btn" title="è³‡æ–™ä¾†æºï¼ˆGoogle è©¦ç®—è¡¨ï¼‰" target="_blank" rel="noopener">
        <i class="ti ti-database"></i><span>è³‡æ–™è¡¨</span>
      </a>-->
      <button id="btnLocate" class="btn" title="å®šä½åˆ°æˆ‘">
        <i class="ti ti-current-location"></i><span>æˆ‘çš„ä½ç½®</span>
      </button>
      <button id="btnToggleSidebar" class="btn" title="æ”¶åˆå´é‚Šæ¬„">
        <i class="ti ti-arrows-left-right"></i><span>åˆ‡æ›å´é‚Šæ¬„</span>
      </button>
    </div>
  </header>
  

  <div class="layout">
    <aside id="sidebar">
      <div class="section">
        <div class="search">
          <input id="q" type="search" placeholder="æœå°‹ï¼šæ´»å‹•åç¨± / åŸå¸‚ / èªè¨€" />
          <button class="btn" id="btnClear"><i class="ti ti-x"></i>æ¸…é™¤</button>
        </div>
        <div style="margin-top:.6rem;display:flex;flex-direction:column;gap:0.6rem;">
          <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
            <label class="toggle"><input type="checkbox" id="toggleThisWeek"> åªçœ‹ã€Œæœ¬é€±ã€</label>
            <span class="badge" id="thisWeekBadge">æœ¬é€±å€é–“è¼‰å…¥ä¸­â€¦</span>
          </div>
          <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
            <label class="toggle"><input type="checkbox" id="toggleNextWeek"> åªçœ‹ã€Œä¸‹é€±ã€</label>
            <span class="badge" id="nextWeekBadge">ä¸‹é€±å€é–“è¼‰å…¥ä¸­â€¦</span>
          </div>
          <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap">
            <label>è‡ªè¨‚å€é–“ï¼š</label>
            <input type="date" id="customStart">
            <input type="date" id="customEnd">
            <button class="btn" id="btnApplyCustom">å¥—ç”¨</button>
          </div>
        </div>        
      </div>

      <div class="section">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <strong>æˆ‘çš„æœ€æ„›</strong>
          <button class="btn" id="btnShowFav"><i class="ti ti-heart"></i> åƒ…é¡¯ç¤º</button>
        </div>
        <div class="list" id="favList" aria-live="polite"></div>
      </div>

      <div class="section">
        <strong>æ‰€æœ‰æ´»å‹•</strong>
      </div>
      <div class="list" id="cards" aria-live="polite"></div>
    </aside>

    <main id="map"></main>
  </div>

  <div id="imgModal" class="modal" role="dialog" aria-modal="true" aria-label="æ´»å‹•åœ–ç‰‡">
    <img alt="æ´»å‹•åœ–ç‰‡" />
  </div>
  
  <footer>
    <div style="display:flex;align-items:center;gap:1em;flex-wrap:wrap;">
      <a href="https://www.threads.com/@languagis_tw" target="_blank" rel="noopener" title="Threads" class="social" style="display:flex;align-items:center;gap:0.4em;">
        é—œæ³¨æˆ‘å€‘ <i class="ti ti-brand-threads"></i>
      </a>
  
      <a href="https://www.instagram.com/languagis_tw/" target="_blank" rel="noopener" title="Instagram" class="social" style="display:flex;align-items:center;gap:0.4em;">
      <i class="ti ti-brand-instagram"></i>
      </a>
  
      <a href="https://forms.gle/hZa37D65N9mMTZbe7" target="_blank" rel="noopener" title="å°æ¸¬æŠ½ç±¤" class="social" style="display:flex;align-items:center;gap:0.4em;">
        å°æ¸¬æŠ½ç±¤ <i class="ti ti-ticket"></i>
      </a>
    </div>
  </footer>
  
  
  <script>
  // ======= ğŸ”§ è¨­å®šå€ï¼ˆè«‹æ›¿æ›ç‚ºä½ çš„ Google Sheet èˆ‡ Google è¡¨å–®ï¼‰ =======
  const SHEET_ID = "10BGq1ztEnqUm3D2leTP-dqiPQ7jvfZOs2sfb5bn-tiA";              // ä¾‹å¦‚ï¼š1AbCdEfGh...ï¼ˆä½æ–¼è¡¨å–®ç¶²å€ä¸­ï¼‰
  const SHEET_NAME = "Meetups";                  // å·¥ä½œè¡¨åç¨±
  const FORM_URL = "https://forms.gle/xhiUFqX77cHAzPAR6"; // ä¾›ã€Œæ–°å¢æ´»å‹•ã€æŒ‰éˆ•é–‹å•Ÿ
  // å»ºè­°æ¬„ä½ï¼šid,title,lat,lng,date,start_time,end_time,city,address,description,languages,fee,signup_url,organizer,cover_image_url,updated_at
  // æ—¥æœŸæ ¼å¼å»ºè­°ï¼šYYYY-MM-DDï¼ˆå°ç£æ™‚é–“ï¼‰

  // ======= ğŸ§  å·¥å…·å‡½å¼ =======
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => [...el.querySelectorAll(q)];
  const fmtCurrency = (n) => (n==null||n==='')? 'â€”' : (isNaN(+n)? n : `NT$${(+n).toLocaleString('zh-TW')}`);
  const toDate = (s) => new Date(s + 'T00:00:00+08:00'); // ä¾å°ç£æ™‚å€æ§‹é€ 

  function getNextWeekRange(){
    // ä»¥å°åŒ—æ™‚å€ç‚ºåŸºæº–ï¼Œå–å¾—ã€Œä¸‹é€±ä¸€ 00:00ã€åˆ°ã€Œä¸‹é€±æ—¥ 23:59:59ã€
    const now = new Date();
    // æ›ç®—æˆå°ç£æ™‚é–“çš„ç¾åœ¨
    const tzNow = new Date(now.toLocaleString('en-US', {timeZone:'Asia/Taipei'}));
    const day = tzNow.getDay(); // 0=Sun..6=Sat
    const daysUntilNextMon = ((8 - day) % 7) || 7; // è‡³å°‘ +1 å¤©
    const nextMon = new Date(tzNow); nextMon.setDate(tzNow.getDate() + daysUntilNextMon); nextMon.setHours(0,0,0,0);
    const nextSun = new Date(nextMon); nextSun.setDate(nextMon.getDate()+6); nextSun.setHours(23,59,59,999);
    return {start: nextMon, end: nextSun};
  }

  const nextWeek = getNextWeekRange();
  const fmtBadge = (d) => d.toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'})
  $('#nextWeekBadge').textContent = `ä¸‹é€±ï¼š${fmtBadge(nextWeek.start)}â€“${fmtBadge(nextWeek.end)}`;


  function getThisWeekRange(){
  const now = new Date();
  const tzNow = new Date(now.toLocaleString('en-US',{timeZone:'Asia/Taipei'}));
  const day = tzNow.getDay(); // 0=Sun..6=Sat
  const thisMon = new Date(tzNow); 
  thisMon.setDate(tzNow.getDate() - ((day+6)%7)); // æ‰¾åˆ°æœ¬é€±ä¸€
  thisMon.setHours(0,0,0,0);
  const thisSun = new Date(thisMon);
  thisSun.setDate(thisMon.getDate()+6);
  thisSun.setHours(23,59,59,999);
  return {start:thisMon, end:thisSun};
  }

  function filterEventsByDateRange(start, end){
    console.log("ğŸ“… ç¯©é¸æ—¥æœŸå€é–“ï¼š", start.toISOString(), "ï½", end.toISOString());
    const filtered = allEvents.filter(ev=>{
      const d = toDate(ev.date);
      return d >= start && d <= end;
    });
    console.log("âœ… ç¯©é¸å¾Œæ´»å‹•æ•¸é‡ï¼š", filtered.length);
    renderEvents(filtered);
  }

  const thisWeek = getThisWeekRange();
  $('#thisWeekBadge').textContent = `æœ¬é€±ï¼š${fmtBadge(thisWeek.start)}â€“${fmtBadge(thisWeek.end)}`;
  $('#nextWeekBadge').textContent = `ä¸‹é€±ï¼š${fmtBadge(nextWeek.start)}â€“${fmtBadge(nextWeek.end)}`;

  // ç¶å®šäº‹ä»¶
  $('#toggleThisWeek').addEventListener('change', e=>{
    if(e.target.checked){
      $('#toggleNextWeek').checked = false;
      filterEventsByDateRange(thisWeek.start, thisWeek.end);
    } else {
      // å¦‚æœå…©å€‹éƒ½æ²’å‹¾ â†’ é¡¯ç¤ºå…¨éƒ¨
      if(!$('#toggleThisWeek').checked && !$('#toggleNextWeek').checked){
        renderEvents(allEvents);
      }
    }
  });

  $('#toggleNextWeek').addEventListener('change', e=>{
    if(e.target.checked){
      $('#toggleThisWeek').checked = false;
      filterEventsByDateRange(nextWeek.start, nextWeek.end);
    } else {
      // å¦‚æœå…©å€‹éƒ½æ²’å‹¾ â†’ é¡¯ç¤ºå…¨éƒ¨
      if(!$('#toggleThisWeek').checked && !$('#toggleNextWeek').checked){
        renderEvents(allEvents);
      }
    }
  });


  $('#btnApplyCustom').addEventListener('click', ()=>{
    const startVal = $('#customStart').value;
    const endVal = $('#customEnd').value;
    if(!startVal || !endVal){
      alert("è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸï¼");
      return;
    }
    const start = new Date(startVal+'T00:00:00+08:00');
    const end = new Date(endVal+'T23:59:59+08:00');
    $('#toggleThisWeek').checked = false;
    $('#toggleNextWeek').checked = false;
    filterEventsByDateRange(start, end);
  });



  // ======= ğŸ—ºï¸ Leaflet åœ°åœ–èˆ‡åº•åœ– =======
  const isMobile = window.innerWidth < 768;

  const map = L.map('map', { 
    zoomControl: false, 
    minZoom: 5, 
    maxZoom: 19,
    //dragging: !isMobile,   // æ‰‹æ©Ÿé—œé–‰æ‹–æ›³
    //tap: !isMobile,        // æ‰‹æ©Ÿé—œé–‰é»æ“Šæ‹–æ›³ bug
    //scrollWheelZoom: !isMobile // æ‰‹æ©Ÿé—œé–‰æ»¾è¼ªç¸®æ”¾
  });  
  L.control.zoom({ position:'bottomright' }).addTo(map);

  // Leaflet åŸæœ¬çš„åº•åœ–
  const baseLayers = {
    'ğŸ—ºï¸ CARTO Positronï¼ˆæ¥µç°¡äº®ï¼‰': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }),
    'ğŸŒ™ CARTO Dark Matterï¼ˆæ¥µç°¡æš—ï¼‰': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }),
    'ğŸ§­ OSM Standard': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }),
    // ====== æ–°å¢ Google Maps style åº•åœ– ======
    'ğŸ¨ LanguaGIS Classics': L.tileLayer('https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i570286820!3m17!2sen!3sUS!5e18!12m4!1e68!2m2!1sset!2sRoadmap!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy50OjF8cy5lOmwudHxwLnY6b2ZmLHMudDoxOXxzLmU6bC50fHAudjpvZmYscy50OjIwfHMuZTpsLnR8cC52Om9mZixzLnQ6ODF8cy5lOmwudHxwLnY6b2ZmLHMudDo4MnxzLmU6Zy5mfHAudjpvbnxwLmM6I2ZmZTBlZmVmLHMudDo4MnxzLmU6bC50fHAudjpvZmYscy50OjJ8cy5lOmcuZnxwLnY6b258cC5oOiMxOTAwZmZ8cC5jOiNmZmMwZThlOCxzLnQ6MnxzLmU6bC50fHAudjpvZmYscy50OjJ8cy5lOmwuaXxwLnY6b2ZmLHMudDozfHMuZTpnfHAubDoxMDB8cC52OnNpbXBsaWZpZWQscy50OjN8cy5lOmx8cC52Om9mZixzLnQ6NHxzLmU6bC50fHAudjpvZmYscy50OjR8cy5lOmwuaXxwLnY6b2ZmLHMudDo2NXxzLmU6Z3xwLnY6b258cC5sOjcwMCxzLnQ6NnxwLmM6I2ZmN2RjZGNk!4e0', {
      attribution: '&copy; Google',
      maxZoom: 20,
      subdomains: ['mt0','mt1','mt2','mt3'],
    }),
  };

  // é è¨­åº•åœ–
  baseLayers['ğŸ¨ LanguaGIS Classics'].addTo(map);

  // åŠ å…¥åœ–å±¤åˆ‡æ›æ§åˆ¶
   // L.control.layers(baseLayers, {}, { position:'topright', collapsed:true }).addTo(map);

  // è‡ºç£è¦–åœ–
  map.setView([23.7, 121.0], 7);

  // ç¾¤èš
  const cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius: 25 });
  map.addLayer(cluster);

  // ======= â­ æˆ‘çš„æœ€æ„›ï¼ˆlocalStorageï¼‰ =======
  const FAV_KEY = 'tw-meetup-favs';
  const getFavs = () => JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
  const setFavs = (ids) => localStorage.setItem(FAV_KEY, JSON.stringify([...new Set(ids)]));
  const toggleFav = (id) => { const s = new Set(getFavs()); s.has(id) ? s.delete(id) : s.add(id); setFavs([...s]); renderFavList(); updateFavIcons(); };
  const isFav = (id) => getFavs().includes(id);

  function updateFavIcons(){ $$('.fav[data-id]').forEach(el=>{ const id = el.dataset.id; const icon = el.querySelector('.ti'); icon.className = `ti ${isFav(id)? 'ti-heart-filled' : 'ti-heart'}`; el.style.color = isFav(id)? 'var(--ok)':'inherit'; }); }

  function renderFavList(){
    const box = $('#favList'); box.innerHTML = '';
    const favIds = getFavs();
    const items = records.filter(r => favIds.includes(r.id));
    if(!items.length){ box.innerHTML = '<div class="meta">å°šç„¡æœ€æ„›ï¼Œé»æ“Šå¡ç‰‡å³ä¸Šè§’æ„›å¿ƒåŠ å…¥ã€‚</div>'; return; }
    for(const r of items){
      const div = document.createElement('div'); div.className = 'card';
      div.innerHTML = `<div class="row"><h3>${r.title}</h3><span class="meta">${r.city || ''}ãƒ»${r.date || ''}</span></div>`;
      div.addEventListener('click', () => { if(r._marker){ map.setView(r._marker.getLatLng(), 15); r._marker.fire('click'); } });
      box.appendChild(div);
    }
  }

  // ======= ğŸ“¥ è®€å–è³‡æ–™ï¼ˆGoogle è©¦ç®—è¡¨ gviz JSONï¼‰ =======
  async function fetchFromSheet(){
    if(!SHEET_ID || SHEET_ID === 'YOUR_SHEET_ID') return null;
    const url = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSNEpCquK6h5mnmoZDPiQtCmg_BSzDdo9SwFpL1-ZcaduHDnhRUeUd2YHsGXIYqlmF14-ValKiej2kH/pub?output=csv`;

    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          console.log(results.data); // â† ç¢ºèªæ¬„ä½æœ‰æ­£ç¢ºè§£æ
          resolve(results.data);
        },
        error: reject
      });
    });
  }


  // ç¯„ä¾‹è³‡æ–™ï¼ˆè‹¥å°šæœªè¨­å®š Sheetï¼Œä½¿ç”¨æ­¤è³‡æ–™æ¸¬è©¦ï¼‰
  const SAMPLE = [
  {id:'demo1', title:'å°åŒ—è‹±èªäº¤æµå¤œ', lat:25.042, lng:121.545, date:'2025-09-04', start_time:'19:00', end_time:'21:00', city:'å°åŒ—', address:'å¤§å®‰å€å¸‚æ°‘å¤§é“å››æ®µ100è™Ÿ', description:'è¼•é¬†å°é…Œã€å¤šèªè¨€è‡ªç”±äº¤æµã€‚', languages:'English / ä¸­æ–‡', fee:'200', signup_url:'https://example.com/ticket', organizer:'@taipei_language_club', cover_image_url:'https://images.unsplash.com/photo-1515165562835-c3b8c1a9fc33?q=80&w=1200&auto=format&fit=crop', updated_at:'2025-08-25'},
  {id:'demo2', title:'é«˜é›„è¥¿èªè§’', lat:22.626, lng:120.297, date:'2025-09-06', start_time:'15:00', end_time:'17:00', city:'é«˜é›„', address:'é¹½åŸ•å€æŸå’–å•¡é¤¨', description:'æ‹‰ä¸éŸ³æ¨‚ & è¥¿èªèŠå¤©ã€‚', languages:'EspaÃ±ol / ä¸­æ–‡', fee:'å…è²»', signup_url:'https://example.com/form', organizer:'@kaohsiung_spanish', cover_image_url:'https://images.unsplash.com/photo-1529101091764-c3526daf38fe?q=80&w=1200&auto=format&fit=crop', updated_at:'2025-08-26'},
  {id:'demo3', title:'å°ä¸­æ—¥èªè®€æ›¸æœƒ', lat:24.147, lng:120.673, date:'2025-09-02', start_time:'19:30', end_time:'21:00', city:'å°ä¸­', address:'è¥¿å€è‹±æ‰è·¯ 88 è™Ÿ', description:'N3â€“N2 é–±è®€ç·´ç¿’èˆ‡å£èªªã€‚', languages:'æ—¥æœ¬èª / ä¸­æ–‡', fee:'150', signup_url:'https://example.com/jp', organizer:'@taichung_jp', cover_image_url:'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?q=80&w=1200&auto=format&fit=crop', updated_at:'2025-08-27'},

  // æ–°å¢è³‡æ–™
  {id:'demo4', title:'Learn Wing Chun & Martial arts in Taiwan (English/Chinese)è© æ˜¥æ‹³', lat:25.0651709, lng:121.492134, date:'2025-09-04', start_time:'11:30', end_time:'', city:'Taipei', address:'b1, No. 62, Daren St, Sanchong District, New Taipei City, 241', description:'Take a break from your day-to-day life by doing something different and come join us to practice è© æ˜¥, short for è© æ˜¥æ‹³, is a martial art that originated centuries ago in China. It is characterized by continuous, circular, slow, relaxed, and smooth-flowing movements. Classes focus on physical and principle aspects. Conducted in English and Chinese.', languages:'English / ä¸­æ–‡', fee:'å…è²»', signup_url:'https://www.meetup.com/hiking-in-taiwan-english-chinese/events/310322735/', organizer:'Hiking in Taiwan (English/Chinese)', cover_image_url:'', updated_at:'2025-09-02'},
  
  {id:'demo5', title:'Language Exchange', lat:24.7991152, lng:120.969159, date:'2025-09-06', start_time:'11:00', end_time:'', city:'Taipei', address:'No. 135è™Ÿ, Zhulian St, East District, Hsinchu City, 300', description:'Casual conversation meetup. All ability levels welcome!', languages:'Chinese / English', fee:'', signup_url:'https://www.meetup.com/meetup-group-ebtrpluk/events/310783280/', organizer:'Hsinchu & Miaoli Chinese/English Language Exchange', cover_image_url:'', updated_at:'2025-09-02'},

  {id:'demo6', title:'å°åŒ—Taipei LGBTQIA+ æ¯é€±èšæœƒWeekly Meetup (Online Event)', lat:'', lng:'', date:'2025-09-04', start_time:'13:00', end_time:'', city:'Taichung', address:'', description:'(English below) æƒ³æ‰¾ä¸€å€‹æ—¢å®‰å…¨åˆå¥½ç©çš„åœ°æ–¹èªè­˜LBGTQIA+åŠå„å€‹ç¤¾ç¾¤çš„æœ‹å‹å—ï¼Ÿç·šä¸Šèšæœƒï¼Œè¨è«–å„ç¨®è©±é¡Œï¼Œç„¡éœ€ä¸‹è¼‰è»Ÿé«”ã€‚', languages:'English / ä¸­æ–‡', fee:'', signup_url:'https://www.meetup.com/taipei-lgbtq-social-group-meetup/events/310535445/', organizer:'Taipei LGBTQIA+ Social Group', cover_image_url:'', updated_at:'2025-09-02'},

  {id:'demo7', title:'Stress Relief Yoga Workshop For Beginners', lat:'', lng:'', date:'2025-09-03', start_time:'13:00', end_time:'', city:'Taichung', address:'', description:'Join us for a rejuvenating Stress Relief Yoga workshop. Focus on calming the mind, relaxing the body, and increasing self-awareness. Learn to breathe consciously, move gracefully, and sit in stillness.', languages:'', fee:'', signup_url:'https://www.meetup.com/taichung-yoga-and-meditation-meetup/events/310518913/', organizer:'Taichung Yoga and Meditation Meetup', cover_image_url:'', updated_at:'2025-09-02'}
];

  let records = [];
  let markers = [];

  function withinNextWeek(rec){
    const d = toDate(rec.date);
    return d >= nextWeek.start && d <= nextWeek.end;
  }

  function matchQuery(rec, q){
    if(!q) return true;
    const bag = `${rec.title} ${rec.city} ${rec.description} ${rec.languages}`.toLowerCase();
    return bag.includes(q.toLowerCase());
  }

function buildPopup(rec) {
  const fee = fmtCurrency(rec.fee);
  const signup = rec.signup_url ? `<a href="${rec.signup_url}" target="_blank" rel="noopener">å‰å¾€å ±å</a>` : 'â€”';
  const org = rec.organizer ? `<span class="badge">ä¸»è¾¦ï¼š${rec.organizer}</span>` : '';
  const time = [rec.date, rec.start_time, rec.end_time].filter(Boolean).join(' ');

  // description è™•ç†ï¼Œæˆªæ–· 100 å­—
  let desc = rec.description || '';
  if (desc.length > 100) {
    desc = desc.substring(0, 100) + '...';
  }

  const html = `
    <div class="popup">
      <div class="info">
        <div class="line"><strong>${rec.title}</strong></div>
        <div class="line meta">${time}</div>
        <div class="line meta">${rec.city || ''} ${rec.address || ''}</div>
        <div class="line">èªè¨€ï¼š<span class="badge">${rec.languages || 'â€”'}</span></div>
        <div class="line">è²»ç”¨ï¼š${fee}</div>
        <div class="line">å ±åï¼š${signup}</div>
        <div class="line">${org}</div>
        <div class="line desc-scroll">${desc}</div>
        <div class="row">
          <span class="fav" data-id="${rec.id}">
            <i class="ti ${isFav(rec.id) ? 'ti-heart-filled' : 'ti-heart'}"></i> åŠ å…¥æœ€æ„›
          </span>
        </div>
      </div>
    </div>`;
  return html;
}



  const gatheringIcon = L.icon({//èšæœƒç¸®åœ–åœ–ç‰‡
    iconUrl: 'gatherings.png', // åœ–ç‰‡è·¯å¾‘
    iconSize: [60, 60],        // åœ–æ¨™å¤§å°ï¼Œå¯ä¾éœ€æ±‚èª¿æ•´
    iconAnchor: [16, 32],      // åœ–æ¨™çš„ã€Œå°–ç«¯ã€å°æ‡‰åˆ°ç¶“ç·¯åº¦çš„ä½ç½®
    popupAnchor: [0, -32]      // popup ç›¸å°åœ–æ¨™çš„ä½ç½®
  });

  function addMarker(rec){
    const m = L.marker([+rec.lat, +rec.lng], {icon: gatheringIcon});
    m.bindPopup(buildPopup(rec), { 
      maxWidth: window.innerWidth < 768 ? 280 : 400, 
      closeButton: true 
    });    
    m.on('popupopen', (e)=>{
      // æ„›å¿ƒ
      const fav = $('.fav', e.popup.getElement());
      if(fav){ fav.addEventListener('click', ()=>{ toggleFav(rec.id); e.popup.setContent(buildPopup(rec)); e.popup.update(); }); }
      // åœ–ç‰‡æ”¾å¤§
      const img = $('.cover', e.popup.getElement());
      if(img){ img.addEventListener('click', ()=>{ $('#imgModal img').src = img.dataset.full; $('#imgModal').classList.add('open'); }); }
    });
    return m;
  }

  function renderList(){
  const q = $('#q').value.trim();
  const onlyNext = $('#toggleNextWeek').checked;
  const onlyFav = $('#btnShowFav').dataset.active === '1';

  // æ¸…é™¤
  cluster.clearLayers(); markers = [];
  $('#cards').innerHTML = '';

  const filtered = records.filter(r => (!onlyNext || withinNextWeek(r)) && matchQuery(r,q) && (!onlyFav || isFav(r.id)));

  // å°‡ç·šä¸Šæ´»å‹•èˆ‡ç·šä¸‹æ´»å‹•åˆ†é–‹
  const online = filtered.filter(r => !r.lat || !r.lng);
  const offline = filtered.filter(r => r.lat && r.lng);

  // æ’åºï¼šç‰¹å®šæ—¥æœŸåœ¨å‰
  offline.sort((a,b)=>{
    if(a.date && !b.date) return -1;
    if(!a.date && b.date) return 1;
    return 0;
  });

  // ======= ç·šä¸‹æ´»å‹•ï¼šåœ°åœ–æ¨™è¨˜èˆ‡å¡ç‰‡ =======
  for(const r of offline){
    // åªåœ¨æœ‰ç¶“ç·¯åº¦æ™‚æ‰æ–°å¢ marker
    let marker = null;
    const lat = parseFloat(r.lat);
    const lng = parseFloat(r.lng);

    if (!isNaN(lat) && !isNaN(lng)) {
        marker = addMarker(r);
        r._marker = marker;
        markers.push(marker);
        cluster.addLayer(marker);
    }

    // å»ºç«‹å¡ç‰‡
    const card = document.createElement('div'); 
    card.className = 'card';
    card.innerHTML = `
      <div class="row">
        <h3>${r.title}</h3>
        <span class="fav" data-id="${r.id}"><i class="ti ${isFav(r.id)?'ti-heart-filled':'ti-heart'}"></i></span>
      </div>
      <div class="meta">${r.city || ''}ãƒ»${r.date || ''} ${r.start_time? 'â€¢ '+r.start_time: ''}</div>
      <div class="meta">èªè¨€ï¼š${r.languages || 'â€”'}ï½œè²»ç”¨ï¼š${fmtCurrency(r.fee)}</div>
    `;
    
    card.addEventListener('click', ()=>{ map.setView([+r.lat, +r.lng], 15); marker.openPopup(); });
    
    card.querySelector('.fav').addEventListener('click', ev=>{
        ev.stopPropagation(); 
        toggleFav(r.id); 
        renderList();
    });
    
    $('#cards').appendChild(card);
  }


    // ======= ç·šä¸Šæ´»å‹•ï¼šå–®ç¨åˆ—è¡¨é¡¯ç¤º =======
    // ======= ç·šä¸Šæ´»å‹•ï¼šå–®ç¨åˆ—è¡¨é¡¯ç¤º =======
    if(online.length){
      const onlineHeader = document.createElement('div');
      onlineHeader.className = 'section';
      onlineHeader.innerHTML = '<strong>ğŸ–¥ï¸ ç·šä¸Šæ´»å‹•ï¼ˆä¸åœ¨åœ°åœ–ä¸Šï¼‰</strong>';
      $('#cards').appendChild(onlineHeader);

      for(const r of online){
        const card = document.createElement('div');
        card.className = 'card';
        card.style.backgroundColor = '#2b2d33'; // ä¸åŒåº•è‰²ï¼Œå€åˆ†ç·šä¸Šæ´»å‹•

        // è™•ç† descriptionï¼Œåªå–å‰ 100 å­—
        let desc = r.description || '';
        if (desc.length > 100) {
          desc = desc.substring(0, 100) + '...';
        }

        card.innerHTML = `
          <div class="row">
            <h3>${r.title}</h3>
            <span class="fav" data-id="${r.id}"><i class="ti ${isFav(r.id)?'ti-heart-filled':'ti-heart'}"></i></span>
          </div>
          <div class="meta">${r.city || ''}ãƒ»${r.date || ''} ${r.start_time? 'â€¢ '+r.start_time: ''}</div>
          <div class="meta">èªè¨€ï¼š${r.languages || 'â€”'}ï½œè²»ç”¨ï¼š${fmtCurrency(r.fee)}</div>
          <div class="meta">å ±åï¼š${r.signup_url? `<a href="${r.signup_url}" target="_blank" rel="noopener">å‰å¾€å ±å</a>` : 'â€”'}</div>
          <div class="line desc-scroll">${desc || ''}</div>
        `;

        card.querySelector('.fav').addEventListener('click', ev=>{
          ev.stopPropagation();
          toggleFav(r.id);
          renderList();
        });

        $('#cards').appendChild(card);
      }
    }


    updateFavIcons();
    renderFavList();

    // åœ°åœ–è‡ªå‹•ç¸®æ”¾åªé‡å°ç·šä¸‹æ´»å‹•
    if(offline.length){
      const g = L.featureGroup(offline.map(r=>r._marker));
      map.fitBounds(g.getBounds().pad(0.15));
    }
  }

  async function init(){
    // é€£çµè¨­å®š
    $('#btnAdd').addEventListener('click', ()=> window.open(FORM_URL, '_blank'));
    //$('#btnSheet').href = SHEET_ID.startsWith('http')? SHEET_ID : `https://docs.google.com/spreadsheets/d/${SHEET_ID}`;

    // æœå°‹èˆ‡ç¯©é¸äº‹ä»¶
    $('#q').addEventListener('input', renderList);
    $('#btnClear').addEventListener('click', ()=>{ $('#q').value=''; renderList(); });
    $('#toggleNextWeek').addEventListener('change', renderList);

    // åƒ…é¡¯ç¤ºæœ€æ„›åˆ‡æ›
    $('#btnShowFav').addEventListener('click', (e)=>{ const on = e.currentTarget.dataset.active === '1'; e.currentTarget.dataset.active = on? '0':'1'; e.currentTarget.classList.toggle('active'); renderList(); });

    // sidebaræ”¶åˆ

    const layout = document.querySelector('.layout');
    const btnToggle = document.getElementById('btnToggleSidebar');

    btnToggle.addEventListener('click', () => {
      layout.classList.toggle('collapsed');
      setTimeout(() => { map.invalidateSize(); }, 310); // ç­‰ CSS transition å®Œå†æ›´æ–°åœ°åœ–å¤§å°
    });


    // å®šä½
    $('#btnLocate').addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude, longitude} = pos.coords; map.setView([latitude, longitude], 14);
        L.circleMarker([latitude, longitude], {radius:6, weight:2, color:'#4caf50'}).addTo(map).bindTooltip('ä½ åœ¨é€™è£¡');
      }, err=> alert('å®šä½å¤±æ•—ï¼š'+err.message));
    });

  // é»æ“Šåœ°åœ–ç©ºç™½è™•è‡ªå‹•æ”¶èµ·å´é‚Šæ¬„ï¼ˆæ‰‹æ©Ÿå°ˆç”¨ï¼‰
  map.on('click', function(e) {
    if(window.innerWidth < 768) { // æ‰‹æ©Ÿ
      const layout = document.querySelector('.layout');
      if(!layout.classList.contains('collapsed')) {
        layout.classList.add('collapsed');
        setTimeout(() => { map.invalidateSize(); }, 310); // CSS transition å®Œå†æ›´æ–°åœ°åœ–
      }
    }
  });


    try{
      const rows = await fetchFromSheet();
      if(rows && rows.length){
        // æ­£è¦åŒ–æ¬„ä½åç¨±
        function cleanRow(row) {
        const clean = {};
        Object.keys(row).forEach(k => {
          const newKey = k.replace(/\r/g, "").trim(); // å»æ‰éš±è—å­—å…ƒèˆ‡å¤šé¤˜ç©ºç™½
          let value = row[k];
          if (typeof value === 'string') {
            value = value.replace(/\r/g, "").trim(); // æ¸…æ‰å€¼è£¡çš„ \r
          }
          clean[newKey] = value;
        });
        return clean;
      }

      // ä½¿ç”¨ç¯„ä¾‹
      records = rows.map(r => {
        const c = cleanRow(r);
        return {
          id: c.id || c.Timestamp || crypto.randomUUID(),
          title: c["æ´»å‹•æ¨™é¡Œ"],
          lat: c.lat,
          lng: c.lng,
          date: c["æ´»å‹•æ—¥æœŸ date"],
          start_time: c["é–‹å§‹æ™‚é–“ from"],
          end_time: c["çµæŸæ™‚é–“ to"],
          city: c["æ´»å‹•åŸå¸‚ city"],
          address: c["æ´»å‹•åœ°å€ address"] ? `"${c["æ´»å‹•åœ°å€ address"].replace(/"/g, '""')}"` : '',
          description: c["æ´»å‹•æè¿° description"],
          fee: c["è²»ç”¨ fee (TWD)"],
          signup_url: c["å ±åé€£çµ sign up"],
          organizer: c["ä¸»è¾¦äºº organizer"],
          //cover_image_url: c["å°é¢åœ–ç‰‡"] || '',
          updated_at: c["æ›´æ–°æ™‚é–“"] || '',
          languages: c["èªè¨€ languages"] || '',
        };
      }).filter(r => r.lat && r.lng);

      }else{
        records = SAMPLE;
      }
    }catch(e){
      console.warn('è®€å–è©¦ç®—è¡¨å¤±æ•—ï¼Œæ”¹ç”¨ç¯„ä¾‹è³‡æ–™', e);
      records = SAMPLE;
    }

    renderList();
  }

  // é—œé–‰å¤§åœ–
  $('#imgModal').addEventListener('click', ()=> $('#imgModal').classList.remove('open'));

  init();
  </script>
</body>
</html>
